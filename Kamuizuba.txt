local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local Plr = Players.LocalPlayer
local Character = Plr.Character or Plr.CharacterAdded:Wait()

-- Tạo hiệu ứng xoáy Kamui
local function CreateKamuiEffect()
    if not Character then return end

    -- Kiểm tra nếu đã có hiệu ứng để tránh trùng lặp
    if Character:FindFirstChild("KamuiEffect") then return end 

    local RootPart = Character:FindFirstChild("HumanoidRootPart")
    if not RootPart then return end

    -- Tạo ParticleEmitter
    local KamuiEffect = Instance.new("ParticleEmitter")
    KamuiEffect.Name = "KamuiEffect"
    KamuiEffect.Parent = RootPart
    KamuiEffect.Texture = "rbxassetid://13226206004" -- Hiệu ứng Portal Kamui
    KamuiEffect.Rate = 50
    KamuiEffect.Speed = NumberRange.new(3, 5)
    KamuiEffect.Size = NumberSequence.new({NumberSequenceKeypoint.new(0, 3), NumberSequenceKeypoint.new(1, 0)})
    KamuiEffect.Lifetime = NumberRange.new(1, 2)
    KamuiEffect.Rotation = NumberRange.new(-180, 180)
    KamuiEffect.RotSpeed = NumberRange.new(-100, 100)
    KamuiEffect.Color = ColorSequence.new(Color3.fromRGB(50, 0, 100), Color3.fromRGB(0, 0, 0)) -- Tím đen
    KamuiEffect.LightEmission = 0.5
    KamuiEffect.Transparency = NumberSequence.new({NumberSequenceKeypoint.new(0, 0), NumberSequenceKeypoint.new(1, 1)})
    KamuiEffect.ZOffset = -2
end

-- Xóa hiệu ứng Kamui khi tắt
local function RemoveKamuiEffect()
    if Character then
        local Effect = Character:FindFirstChild("KamuiEffect")
        if Effect then
            Effect:Destroy()
        end
    end
end

-- Chỉnh lại Toggle để thêm hiệu ứng Kamui
Toggle.MouseButton1Click:connect(function()
    if Status.Text == "off" then
        Clipon = true
        Status.Text = "on"
        Status.TextColor3 = Color3.fromRGB(0, 255, 0) -- Xanh khi bật
        CreateKamuiEffect() -- Bật hiệu ứng Kamui

        Stepped = RunService.Stepped:Connect(function()
            if not Clipon == false then
                for _, b in pairs(Workspace:GetChildren()) do
                    if b.Name == Plr.Name then
                        for _, v in pairs(Workspace[Plr.Name]:GetChildren()) do
                            if v:IsA("BasePart") then
                                v.CanCollide = false
                            end
                        end
                    end
                end
            else
                Stepped:Disconnect()
            end
        end)

    elseif Status.Text == "on" then
        Clipon = false
        Status.Text = "off"
        Status.TextColor3 = Color3.fromRGB(255, 0, 0) -- Đỏ khi tắt
        RemoveKamuiEffect() -- Xóa hiệu ứng Kamui
    end
end)
